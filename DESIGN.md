# Gemini CLI (Go) - 設計ドキュメント

## 1. 目的

既存の `@google/gemini-cli` の機能をGo言語で再実装し、より高速で効率的なCLIツールを提供することを目的とする。Go言語の並行処理、強力な型付け、単一バイナリ生成の利点を活用し、クロスプラットフォームでの配布と実行を容易にする。

## 2. スコープ

*   既存の `@google/gemini-cli` の主要なコマンドと機能をGo言語で再現する。
*   Gemini APIとの連携（認証、リクエスト、レスポンス処理）。
*   ファイルシステム操作（コードベースの読み込み、変更）。
*   ユーザーインターフェース（コマンドライン引数解析、出力表示）。
*   エラーハンドリングとロギング。

## 3. アーキテクチャ

### 3.1. 全体構造

```
gemini-cli-go/
├── cmd/            # CLIコマンドの定義
│   └── gemini/     # メインコマンド
│       └── main.go
├── internal/       # 内部パッケージ
│   ├── api/        # Gemini APIクライアント
│   ├── auth/       # 認証ロジック
│   ├── config/     # 設定管理
│   ├── filesystem/ # ファイルシステム操作ユーティリティ
│   └── ui/         # ユーザーインターフェース関連
└── pkg/            # 再利用可能なライブラリ（外部公開用）
    └── ...
```

### 3.2. 主要コンポーネント

*   **`cmd/gemini/main.go`**: CLIのエントリポイント。`cobra` などのCLIフレームワークを使用してコマンドを定義する。
*   **`internal/api`**: Gemini APIとの通信を抽象化する。HTTPクライアント、リクエスト/レスポンスの構造体定義、エラー処理など。
    *   `gemini.go`: `GenerateContent` メソッドを持つ `Client` 構造体を定義。`NewClient` 関数は、APIキーまたはOAuth2で設定された `*http.Client` のいずれかを受け取れるように修正された。APIキーが提供され、かつデフォルトのHTTPクライアントが使用されている場合にのみ `x-goog-api-key` ヘッダーを設定する。
    *   `formatter.go`: `FileContent` スライスをGemini APIに適した文字列形式に整形する `FormatFilesForGemini` 関数を実装。
*   **`internal/auth`**: Googleアカウント認証、APIキー管理など、認証関連のロジックを扱う。
    *   現時点では、`GEMINI_API_KEY` 環境変数からのAPIキー読み込みをサポート。
    *   **今後の計画**: OAuth2フローによるGoogleアカウント認証を実装し、よりセキュアでユーザーフレンドリーな認証メカニズムを提供する。
        *   **OAuth2フロー**:
            1.  ユーザーをGoogleの認証ページにリダイレクトし、認証コードを取得する。
            2.  取得した認証コードとクライアントシークレットを使用して、アクセストークンとリフレッシュトークンを交換する。
            3.  アクセストークンをメモリまたは一時的なストレージに保存し、APIリクエストに使用する。
            4.  リフレッシュトークンを安全な場所に保存し、アクセストークンの有効期限が切れた際に新しいアクセストークンを取得するために使用する。
        *   **使用ライブラリ**: Google Cloud SDK for Go の `golang.org/x/oauth2` パッケージや、`google.golang.org/api/option` パッケージなどを検討。
        *   **CLIでのUX**: 認証URLをユーザーに提示し、ブラウザで開くように促す。認証完了後、CLIが自動的にトークンを取得できるように、ローカルサーバーを一時的に立ち上げるなどの工夫が必要。
*   **`internal/config`**: 設定ファイルの読み込み、保存、管理。
    *   `config.go`: OAuth2トークンをユーザーのホームディレクトリ下の `.gemini-cli-go/token.json` にJSON形式で保存・読み込みする `SaveToken` および `LoadToken` 関数を実装。ファイルパーミッションは `0600` で設定し、セキュリティを確保する。
*   **`internal/ui`**: ユーザーへの出力表示（プログレスバー、スピナー、色付き出力など）。

## 4. 技術スタック

*   **言語**: Go
*   **CLIフレームワーク**: `cobra` (コマンドライン引数解析、サブコマンド管理)
*   **HTTPクライアント**: Go標準ライブラリの `net/http`
*   **認証**: Google Cloud SDK for Go または OAuth2 ライブラリ
*   **ファイルシステム**: Go標準ライブラリの `os`, `path/filepath`
*   **ロギング**: Go標準ライブラリの `log` または `zap` / `logrus`
*   **テスト**: Go標準ライブラリの `testing`

## 5. 開発計画

### フェーズ1: 基本機能と基盤の確立 (完了)

1.  **プロジェクトの初期設定**: Goモジュールの初期化、基本的なディレクトリ構造の作成。
2.  **CLIフレームワークの導入**: `cobra` を使用した基本的なコマンドの定義（例: `gemini version`）。
3.  **Gemini APIとの疎通確認**: 最小限のAPIクライアントを作成し、簡単なテキスト生成リクエストを送信。
4.  **認証メカニズムの検討と実装**: APIキーによる認証フローの確立。
5.  **基本的なファイル操作**: 指定されたファイルを読み込む機能の実装。

### フェーズ2: コードベース連携と高度な機能

1.  **コードベースの読み込みと解析**:
    *   指定されたディレクトリ内のファイルを再帰的に読み込む機能。
    *   特定のファイルタイプ（例: `.go`, `.js`, `.ts`, `.py`）をフィルタリングする機能。
    *   ファイル内容をGemini APIに送信できる形式に整形する機能。
2.  **コード生成コマンドの実装**:
    *   プロンプトとコードベースのコンテキストに基づいてコードを生成するコマンド（例: `gemini generate-code`）。
    *   `--context-dir` フラグで指定されたディレクトリからファイルを読み込み、`--ext` フラグでフィルタリングする。
    *   読み込んだファイルを `FormatFilesForGemini` で整形し、プロンプトに含めてGemini APIに送信する。
    *   生成されたコードを標準出力に表示する。
3.  **コードの変更・修正コマンドの実装**:
    *   既存のコードをプロンプトに基づいて修正するコマンド（例: `gemini refactor`）。
    *   差分表示とユーザーによる確認・承認フローの検討。
4.  **エラーハンドリングとユーザーフィードバックの強化**:
    *   より詳細なエラーメッセージと、問題解決のためのヒントの提供。
    *   プログレス表示やスピナーなど、CLIのUX改善。
